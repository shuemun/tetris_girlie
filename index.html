<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>tetris ♡</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{--cream:#faf6f1;--warm-white:#fff9f5;--blush:#f2d4d0;--rose:#d4868c;--dusty-rose:#c4737a;--soft-pink:#f0c0be;--mauve:#b88a95;--sage:#a8b5a0;--sky:#a3bdd4;--lavender:#b8a9d4;--butter:#e8d8a3;--peach:#e8b89d;--terracotta:#c49080;--text:#5a3e42;--text-soft:#9b7e82;--text-faint:#c4a8ab;--glass:rgba(255,255,255,0.55);--glass-border:rgba(212,134,140,0.18);--shadow:rgba(90,62,66,0.06)}
html{height:100%}
body{background:var(--cream);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;display:flex;justify-content:center;align-items:center;overflow:hidden;position:relative}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 20%,rgba(242,212,208,0.25) 0%,transparent 50%),radial-gradient(ellipse at 80% 80%,rgba(184,169,212,0.12) 0%,transparent 50%),radial-gradient(ellipse at 60% 30%,rgba(168,181,160,0.08) 0%,transparent 40%);pointer-events:none}
.petal{position:fixed;pointer-events:none;z-index:0;opacity:0;animation:petalFall linear infinite}
@keyframes petalFall{0%{transform:translateY(-5vh) rotate(0deg) translateX(0);opacity:0}8%{opacity:0.07}85%{opacity:0.07}100%{transform:translateY(105vh) rotate(360deg) translateX(40px);opacity:0}}
.game-wrapper{position:relative;z-index:1;display:flex;gap:22px;align-items:flex-start}
.side-panel{width:146px;display:flex;flex-direction:column;gap:14px}
.panel-box{background:var(--glass);border:1px solid var(--glass-border);border-radius:14px;padding:14px 16px;backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);box-shadow:0 2px 20px var(--shadow)}
.panel-label{font-size:9px;font-weight:600;letter-spacing:2.5px;text-transform:uppercase;color:var(--text-faint);margin-bottom:6px}
.score-value{font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:600;color:var(--dusty-rose)}
.level-value{font-family:'Cormorant Garamond',serif;font-size:32px;font-weight:600;color:var(--lavender)}
.lines-value{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:600;color:var(--sage)}
.next-preview{display:flex;justify-content:center;align-items:center;min-height:70px}
.board-container{position:relative;border-radius:16px;padding:3px;background:linear-gradient(145deg,rgba(212,134,140,0.2),rgba(184,169,212,0.15),rgba(168,181,160,0.1));box-shadow:0 8px 40px rgba(212,134,140,0.1),0 1px 3px rgba(90,62,66,0.05)}
#game-canvas{display:block;border-radius:13px;background:var(--warm-white)}

/* Song list */
.song-list{display:flex;flex-direction:column;gap:4px;max-height:220px;overflow-y:auto;padding-right:4px;scrollbar-width:thin;scrollbar-color:var(--blush) transparent}
.song-list::-webkit-scrollbar{width:3px}
.song-list::-webkit-scrollbar-thumb{background:var(--blush);border-radius:3px}
.song-btn{width:100%;padding:6px 8px;border-radius:8px;border:1px solid transparent;background:transparent;font-family:'DM Sans',sans-serif;font-size:10px;font-weight:500;color:var(--text-faint);cursor:pointer;transition:all 0.2s;text-align:left;display:flex;align-items:center;gap:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.song-btn:hover{background:rgba(242,212,208,0.15);color:var(--text-soft)}
.song-btn.active{border-color:var(--glass-border);color:var(--dusty-rose);background:rgba(242,212,208,0.2)}
.song-btn .dot{width:5px;height:5px;border-radius:50%;background:var(--text-faint);flex-shrink:0;transition:all 0.2s}
.song-btn.active .dot{background:var(--rose);box-shadow:0 0 5px rgba(212,134,140,0.5)}
.song-btn.playing .dot{animation:pulse 1.2s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.5);opacity:0.6}}

.music-row{display:flex;gap:5px;margin-top:6px}
.ctrl-btn{flex:1;padding:5px;border-radius:7px;border:1px solid var(--glass-border);background:transparent;font-family:'DM Sans',sans-serif;font-size:9px;font-weight:500;color:var(--text-faint);cursor:pointer;transition:all 0.2s;letter-spacing:0.5px;text-align:center}
.ctrl-btn:hover{border-color:var(--soft-pink);color:var(--text-soft)}
.ctrl-btn.active{color:var(--dusty-rose);border-color:var(--rose)}
.ctrl-btn.muted{color:var(--terracotta);border-color:var(--terracotta)}

.controls-info{font-size:10px;line-height:2;color:var(--text-faint)}
.controls-info kbd{display:inline-block;font-family:'DM Sans',sans-serif;font-size:9px;font-weight:600;color:var(--text-soft);background:rgba(212,134,140,0.08);border:1px solid rgba(212,134,140,0.12);border-radius:4px;padding:1px 5px;margin-right:2px}
.overlay{position:absolute;inset:3px;border-radius:13px;background:rgba(250,246,241,0.95);display:flex;flex-direction:column;justify-content:center;align-items:center;gap:16px;z-index:10;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);transition:opacity 0.4s ease}
.overlay.hidden{opacity:0;pointer-events:none}
.overlay h1{font-family:'Cormorant Garamond',serif;font-size:52px;font-weight:400;font-style:italic;color:var(--dusty-rose);letter-spacing:2px}
.overlay h2{font-family:'Cormorant Garamond',serif;font-size:32px;font-weight:400;font-style:italic;color:var(--terracotta)}
.overlay .final-score{font-family:'Cormorant Garamond',serif;font-size:18px;color:var(--dusty-rose)}
.overlay .subtitle{font-size:12px;color:var(--text-faint);letter-spacing:1px}
.start-btn{font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;letter-spacing:3px;padding:13px 44px;border:1.5px solid var(--rose);background:transparent;color:var(--dusty-rose);border-radius:30px;cursor:pointer;transition:all 0.3s;text-transform:uppercase}
.start-btn:hover{background:var(--rose);color:white;box-shadow:0 4px 20px rgba(212,134,140,0.3);transform:translateY(-1px)}
.name-input{font-family:'DM Sans',sans-serif;font-size:14px;font-weight:500;color:var(--text);text-align:center;padding:10px 20px;border:1.5px solid var(--glass-border);border-radius:20px;background:var(--warm-white);outline:none;width:200px;transition:border-color 0.2s}
.name-input::placeholder{color:var(--text-faint)}
.name-input:focus{border-color:var(--rose)}
.pause-indicator{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Cormorant Garamond',serif;font-size:26px;font-style:italic;color:var(--mauve);z-index:10;display:none;letter-spacing:4px}
.now-playing{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);font-size:9px;font-weight:500;color:var(--text-faint);letter-spacing:1px;z-index:5;white-space:nowrap;opacity:0.6;max-width:280px;overflow:hidden;text-overflow:ellipsis}
.mobile-controls{display:none;position:fixed;bottom:14px;left:0;right:0;justify-content:center;gap:10px;z-index:100;padding:0 20px}
.mobile-btn{width:52px;height:52px;border-radius:50%;border:1px solid var(--glass-border);background:var(--glass);color:var(--dusty-rose);font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;-webkit-tap-highlight-color:transparent;user-select:none;backdrop-filter:blur(10px);box-shadow:0 2px 10px var(--shadow)}
.mobile-btn:active{background:rgba(242,212,208,0.4);border-color:var(--rose)}
@media(max-width:720px){.game-wrapper{flex-direction:column;align-items:center;gap:10px;transform:scale(0.78);transform-origin:center center}.side-panel{flex-direction:row;width:auto;gap:8px}.side-panel .panel-box{padding:10px 12px}.side-panel.right{display:none}.mobile-controls{display:flex}}
</style>
</head>
<body>
<script>
const pc=['✿','❀','♡','·','✧'];
for(let i=0;i<10;i++){const el=document.createElement('div');el.className='petal';el.textContent=pc[i%pc.length];el.style.left=(Math.random()*100)+'%';el.style.fontSize=(10+Math.random()*14)+'px';el.style.animationDuration=(18+Math.random()*22)+'s';el.style.animationDelay=(Math.random()*20)+'s';el.style.color=['#d4868c','#b8a9d4','#a8b5a0','#e8b89d'][i%4];document.body.appendChild(el);}
</script>
<div class="game-wrapper">
  <div class="side-panel">
    <div class="panel-box"><div class="panel-label">Score</div><div class="score-value" id="score">0</div></div>
    <div class="panel-box"><div class="panel-label">Level</div><div class="level-value" id="level">1</div></div>
    <div class="panel-box"><div class="panel-label">Lines</div><div class="lines-value" id="lines">0</div></div>
    <div class="panel-box"><div class="panel-label">Hold</div><div class="next-preview" id="hold-preview"></div></div>
  </div>
  <div class="board-container">
    <canvas id="game-canvas" width="300" height="600"></canvas>
    <div class="pause-indicator" id="pause-text">paused</div>
    <div class="now-playing" id="now-playing"></div>
    <div class="overlay" id="start-overlay">
      <h1>tetris</h1>
      <div class="subtitle">shuffle · play · vibe</div>
      <input type="text" class="name-input" id="name-input" placeholder="enter your name ♡" maxlength="15" autocomplete="off">
      <button class="start-btn" id="start-btn">play</button>
      <div class="controls-info" style="text-align:center;margin-top:6px">
        <kbd>←</kbd><kbd>→</kbd> move · <kbd>↑</kbd> rotate · <kbd>↓</kbd> soft drop<br>
        <kbd>space</kbd> hard drop · <kbd>c</kbd> hold · <kbd>p</kbd> pause
      </div>
    </div>
    <div class="overlay hidden" id="gameover-overlay">
      <h2>game over</h2>
      <div class="final-score" id="final-score"></div>
      <input type="text" class="name-input" id="name-input-retry" placeholder="change name?" maxlength="15" autocomplete="off">
      <button class="start-btn" id="restart-btn">again</button>
    </div>
  </div>
  <div class="side-panel right">
    <div class="panel-box"><div class="panel-label">Next</div><div class="next-preview" id="next-preview"></div></div>
    <div class="panel-box">
      <div class="panel-label">Now Playing</div>
      <div class="song-list" id="song-list"></div>
      <div class="music-row">
        <button class="ctrl-btn active" id="shuffle-btn">⟳ shuffle</button>
        <button class="ctrl-btn" id="skip-btn">skip ›</button>
        <button class="ctrl-btn" id="mute-btn">♫</button>
      </div>
    </div>
    <div class="panel-box">
      <div class="controls-info">
        <kbd>←</kbd><kbd>→</kbd> move<br><kbd>↑</kbd> rotate<br><kbd>↓</kbd> soft drop<br>
        <kbd>space</kbd> hard drop<br><kbd>c</kbd> hold · <kbd>p</kbd> pause<br><kbd>m</kbd> mute · <kbd>n</kbd> skip
      </div>
    </div>
  </div>
</div>
<div class="mobile-controls">
  <div class="mobile-btn" data-action="left">◂</div>
  <div class="mobile-btn" data-action="rotate">↻</div>
  <div class="mobile-btn" data-action="down">▾</div>
  <div class="mobile-btn" data-action="drop">⤓</div>
  <div class="mobile-btn" data-action="right">▸</div>
</div>
<script>
(()=>{
const COLS=10,ROWS=20,CELL=30;
const canvas=document.getElementById('game-canvas');
const ctx=canvas.getContext('2d');
const COLORS={I:'#a3bdd4',O:'#e8d8a3',T:'#b8a9d4',S:'#a8b5a0',Z:'#d4868c',J:'#89a5c4',L:'#e8b89d'};
const GLOW={I:'rgba(163,189,212,0.3)',O:'rgba(232,216,163,0.3)',T:'rgba(184,169,212,0.3)',S:'rgba(168,181,160,0.3)',Z:'rgba(212,134,140,0.3)',J:'rgba(137,165,196,0.3)',L:'rgba(232,184,157,0.3)'};
const SHAPES={I:[[0,0],[1,0],[2,0],[3,0]],O:[[0,0],[1,0],[0,1],[1,1]],T:[[0,0],[1,0],[2,0],[1,1]],S:[[1,0],[2,0],[0,1],[1,1]],Z:[[0,0],[1,0],[1,1],[2,1]],J:[[0,0],[0,1],[1,1],[2,1]],L:[[2,0],[0,1],[1,1],[2,1]]};
const TYPES=Object.keys(SHAPES);
let board,piece,nextPiece,holdPiece,canHold,score,level,lines,gameOver,paused,started;
let dropInterval,dropTimer,lastTime,animFrame,flashRows=[];

// ═══════ MUSIC SYSTEM ═══════
const songs=[
  {name:'Espresso — Sabrina Carpenter',src:'espresso.mp3'},
  {name:'Tears — Sabrina Carpenter',src:'tears.mp3'},
  {name:'Nonsense — Sabrina Carpenter',src:'nonsense.mp3'},
  {name:'Talk Talk — Charli XCX ft. Troye Sivan',src:'talk-talk.mp3'},
  {name:'Guess — Charli XCX ft. Billie Eilish',src:'guess.mp3'},
  {name:'360 — Charli XCX',src:'360.mp3'},
  {name:'Von Dutch — Charli XCX',src:'von-dutch.mp3'},
  {name:'365 — Charli XCX',src:'365.mp3'},
  {name:'Apple — Charli XCX',src:'apple.mp3'},
  {name:'OMG (Remix) — NewJeans',src:'omg.mp3'},
  {name:'Super Shy — NewJeans',src:'super-shy.mp3'},
  {name:'Just Keep Watching — Tate McRae',src:'just-keep-watching.mp3'},
  {name:'I Wanna Go — Britney Spears',src:'i-wanna-go.mp3'},
  {name:'Born This Way — Lady Gaga',src:'born-this-way.mp3'},
  {name:'Diva — Beyoncé',src:'diva.mp3'},
  {name:'3 Strikes — Terror Jr',src:'3-strikes.mp3'},
  {name:'Luther — Kendrick Lamar & SZA',src:'luther.mp3'},
  {name:'Break Free — Ariana Grande',src:'break-free.mp3'},
  {name:'Baby — Justin Bieber ft. Ludacris',src:'baby.mp3'},
  {name:'Boyfriend — Big Time Rush',src:'boyfriend.mp3'},
  {name:'Cookie — NewJeans',src:'cookie.mp3'},
  {name:'Gameboy x Agora Hills — KATSEYE & Doja Cat',src:'gameboy-agora-hills.mp3'},
  {name:'Like Jennie — JENNIE',src:'like-jennie.mp3'},
  {name:'Crazy — LE SSERAFIM',src:'crazy.mp3'},
  {name:'Magnetic — ILLIT',src:'magnetic.mp3'},
  {name:'Eenie Meenie — Sean Kingston & Justin Bieber',src:'eenie-meenie.mp3'},
  {name:'Angel — Akon',src:'angel.mp3'},
  {name:'I Like It — Cardi B, Bad Bunny & J Balvin',src:'i-like-it.mp3'},
  {name:'Perfect Night — LE SSERAFIM',src:'perfect-night.mp3'},
  {name:'California Gurls — Katy Perry ft. Snoop Dogg',src:'california-gurls.mp3'},
  {name:'Super Bass — Nicki Minaj',src:'super-bass.mp3'},
  {name:'Beauty And A Beat — Justin Bieber ft. Nicki Minaj',src:'beauty-and-a-beat.mp3'},
  {name:'Wannabe — Spice Girls',src:'wannabe.mp3'},
  {name:'I Really Like You — Carly Rae Jepsen',src:'i-really-like-you.mp3'},
  {name:'Like A G6 — Far East Movement',src:'like-a-g6.mp3'},
  {name:'Sexy And I Know It — LMFAO',src:'sexy-and-i-know-it.mp3'},
  {name:'Hips Don\'t Lie — Shakira ft. Wyclef Jean',src:'hips-dont-lie.mp3'},
  {name:'Waka Waka — Shakira',src:'waka-waka.mp3'},
];

let currentSong=0,muted=false,shuffleOn=true;
let shuffleQueue=[];
const audios=songs.map(s=>{const a=new Audio(s.src);a.volume=0.4;return a;});

// Build song list UI
const songListEl=document.getElementById('song-list');
const songBtns=[];
songs.forEach((s,i)=>{
  const btn=document.createElement('button');
  btn.className='song-btn'+(i===0?' active':'');
  btn.innerHTML='<span class="dot"></span>'+s.name.split(' — ')[0];
  btn.title=s.name;
  btn.addEventListener('click',()=>switchSong(i));
  songListEl.appendChild(btn);
  songBtns.push(btn);
});

const muteB=document.getElementById('mute-btn');
const shuffleB=document.getElementById('shuffle-btn');
const skipB=document.getElementById('skip-btn');
const nowPlaying=document.getElementById('now-playing');

// Shuffle queue
function buildShuffleQueue(){
  shuffleQueue=[...Array(songs.length).keys()].sort(()=>Math.random()-0.5);
}
buildShuffleQueue();

function getNextSongIdx(){
  if(!shuffleOn) return (currentSong+1)%songs.length;
  if(shuffleQueue.length===0) buildShuffleQueue();
  let next=shuffleQueue.pop();
  // avoid repeating same song
  if(next===currentSong&&shuffleQueue.length>0) next=shuffleQueue.pop();
  return next;
}

// Auto-play next song when current ends
audios.forEach((a,i)=>{
  a.addEventListener('ended',()=>{
    if(gameOver||!started||paused||muted) return;
    skipSong();
  });
});

function switchSong(idx){
  audios[currentSong].pause();
  audios[currentSong].currentTime=0;
  currentSong=idx;
  songBtns.forEach((b,i)=>{b.classList.toggle('active',i===idx);b.classList.remove('playing');});
  songBtns[idx].scrollIntoView({block:'nearest',behavior:'smooth'});
  if(started&&!gameOver&&!paused&&!muted){
    audios[idx].play().catch(()=>{});
    songBtns[idx].classList.add('playing');
  }
  updNP();
}

function updNP(){nowPlaying.textContent=(muted||!started||gameOver)?'':'♫ '+songs[currentSong].name;}

// Resume current song (used when unpausing)
function resumeMusic(){
  if(muted)return;
  audios[currentSong].play().catch(()=>{});
  songBtns[currentSong].classList.add('playing');
  updNP();
}

// Start a new random song (used on game start / restart)
function playNewSong(){
  if(muted)return;
  const idx=shuffleOn?getNextSongIdx():0;
  switchSong(idx);
}

// Skip to next song
function skipSong(){
  const next=getNextSongIdx();
  switchSong(next);
}

function pauseAll(){audios.forEach(a=>a.pause());songBtns.forEach(b=>b.classList.remove('playing'));}
function stopAll(){audios.forEach(a=>{a.pause();a.currentTime=0;});songBtns.forEach(b=>b.classList.remove('playing'));nowPlaying.textContent='';}

muteB.addEventListener('click',()=>{
  muted=!muted;
  muteB.textContent=muted?'✕':'♫';
  muteB.classList.toggle('muted',muted);
  if(muted){pauseAll();nowPlaying.textContent='';}
  else if(started&&!gameOver&&!paused)resumeMusic();
});

shuffleB.addEventListener('click',()=>{
  shuffleOn=!shuffleOn;
  shuffleB.classList.toggle('active',shuffleOn);
  if(shuffleOn) buildShuffleQueue();
});

skipB.addEventListener('click',()=>{
  if(!started||gameOver)return;
  skipSong();
});

// ═══════ SFX ═══════
let sfxCtx=null,sfxGain=null;
function initSfx(){if(sfxCtx)return;sfxCtx=new(window.AudioContext||window.webkitAudioContext)();sfxGain=sfxCtx.createGain();sfxGain.gain.value=0.25;sfxGain.connect(sfxCtx.destination);}
function sfxN(f,s,d,w='sine',v=0.12){if(!sfxCtx||muted)return;const o=sfxCtx.createOscillator(),g=sfxCtx.createGain();o.type=w;o.frequency.value=f;g.gain.setValueAtTime(v,s);g.gain.exponentialRampToValueAtTime(0.001,s+d-0.005);o.connect(g);g.connect(sfxGain);o.start(s);o.stop(s+d);}
function sfxMove(){if(!sfxCtx||muted)return;sfxN(700,sfxCtx.currentTime,0.035,'sine',0.08);}
function sfxRotate(){if(!sfxCtx||muted)return;const t=sfxCtx.currentTime;sfxN(550,t,0.035,'sine',0.08);sfxN(800,t+0.035,0.035,'sine',0.08);}
function sfxDrop(){if(!sfxCtx||muted)return;const t=sfxCtx.currentTime;sfxN(260,t,0.06,'triangle',0.14);sfxN(140,t+0.04,0.08,'triangle',0.1);}
function sfxClear(n){if(!sfxCtx||muted)return;const t=sfxCtx.currentTime;(n>=4?[523,659,784,1047]:[440,554,659]).forEach((f,i)=>sfxN(f,t+i*0.06,0.14,'sine',0.14));}
function sfxOver(){if(!sfxCtx||muted)return;const t=sfxCtx.currentTime;[460,390,320,230].forEach((f,i)=>sfxN(f,t+i*0.18,0.3,'triangle',0.12));}

// ═══════ GAME ═══════
let bag=[];
function nextType(){if(!bag.length)bag=[...TYPES].sort(()=>Math.random()-0.5);return bag.pop();}
function createPiece(t){return{type:t,cells:SHAPES[t].map(c=>[...c]),x:Math.floor(COLS/2)-(t==='I'?2:t==='O'?1:1),y:-1};}
function rotCells(cells){const xs=cells.map(c=>c[0]),ys=cells.map(c=>c[1]);const cx=(Math.min(...xs)+Math.max(...xs))/2,cy=(Math.min(...ys)+Math.max(...ys))/2;return cells.map(([x,y])=>[Math.round(cy-y+cx),Math.round(x-cx+cy)]);}
function valid(cells,ox,oy){return cells.every(([x,y])=>{const nx=x+ox,ny=y+oy;return nx>=0&&nx<COLS&&ny<ROWS&&(ny<0||board[ny][nx]===0);});}
function lock(){piece.cells.forEach(([x,y])=>{const ny=y+piece.y;if(ny>=0)board[ny][x+piece.x]=piece.type;});clearLines();piece=nextPiece;nextPiece=createPiece(nextType());canHold=true;drawNP();if(!valid(piece.cells,piece.x,piece.y)){gameOver=true;stopAll();sfxOver();
      document.getElementById('final-score').textContent=playerName+' · score: '+score;
      document.getElementById('gameover-overlay').classList.remove('hidden');}}
function clearLines(){const full=[];for(let r=0;r<ROWS;r++)if(board[r].every(c=>c!==0))full.push(r);if(!full.length)return;sfxClear(full.length);flashRows=full;setTimeout(()=>{full.forEach(r=>{board.splice(r,1);board.unshift(new Array(COLS).fill(0));});flashRows=[];},280);score+=[0,100,300,500,800][full.length]*level;lines+=full.length;level=Math.floor(lines/10)+1;updateUI();}
function updateUI(){document.getElementById('score').textContent=score;document.getElementById('level').textContent=level;document.getElementById('lines').textContent=lines;}
function ghostY(){let gy=piece.y;while(valid(piece.cells,piece.x,gy+1))gy++;return gy;}

// ═══════ DRAW ═══════
function drawCell(x,y,type,alpha=1){
  const px=x*CELL,py=y*CELL;ctx.globalAlpha=alpha;
  const r=5,bx=px+1.5,by=py+1.5,bw=CELL-3,bh=CELL-3;
  ctx.fillStyle=COLORS[type];ctx.beginPath();ctx.roundRect(bx,by,bw,bh,r);ctx.fill();
  const grad=ctx.createLinearGradient(bx,by,bx,by+bh);
  grad.addColorStop(0,'rgba(255,255,255,0.4)');grad.addColorStop(0.35,'rgba(255,255,255,0.05)');grad.addColorStop(1,'rgba(0,0,0,0.04)');
  ctx.fillStyle=grad;ctx.beginPath();ctx.roundRect(bx,by,bw,bh,r);ctx.fill();
  ctx.strokeStyle='rgba(255,255,255,0.25)';ctx.lineWidth=0.5;ctx.beginPath();ctx.roundRect(bx+0.5,by+0.5,bw-1,bh-1,r-0.5);ctx.stroke();
  ctx.globalAlpha=1;
}
function drawBoard(){
  ctx.fillStyle='#fff9f5';ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='rgba(212,134,140,0.04)';
  for(let x=0;x<COLS;x++)for(let y=0;y<ROWS;y++){ctx.beginPath();ctx.arc(x*CELL+CELL/2,y*CELL+CELL/2,1,0,Math.PI*2);ctx.fill();}
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){if(board[r][c]){if(flashRows.includes(r))drawCell(c,r,board[r][c],(Date.now()%180)>90?1:0.15);else drawCell(c,r,board[r][c]);}}
  if(!piece||gameOver)return;
  const gy=ghostY();piece.cells.forEach(([x,y])=>{const ny=y+gy;if(ny>=0)drawCell(x+piece.x,ny,piece.type,0.15);});
  ctx.shadowColor=GLOW[piece.type];ctx.shadowBlur=10;
  piece.cells.forEach(([x,y])=>{const ny=y+piece.y;if(ny>=0)drawCell(x+piece.x,ny,piece.type);});
  ctx.shadowBlur=0;
}
function drawMini(container,type){
  container.innerHTML='';if(!type)return;
  const cells=SHAPES[type],xs=cells.map(c=>c[0]),ys=cells.map(c=>c[1]);
  const w=Math.max(...xs)-Math.min(...xs)+1,h=Math.max(...ys)-Math.min(...ys)+1,s=16;
  const cvs=document.createElement('canvas');cvs.width=w*s;cvs.height=h*s;
  const c=cvs.getContext('2d');const ox=Math.min(...xs),oy=Math.min(...ys);
  cells.forEach(([x,y])=>{const px=(x-ox)*s,py=(y-oy)*s;c.fillStyle=COLORS[type];c.beginPath();c.roundRect(px+1,py+1,s-2,s-2,3);c.fill();const g=c.createLinearGradient(px,py,px,py+s);g.addColorStop(0,'rgba(255,255,255,0.35)');g.addColorStop(0.4,'rgba(255,255,255,0)');c.fillStyle=g;c.beginPath();c.roundRect(px+1,py+1,s-2,s-2,3);c.fill();});
  container.appendChild(cvs);
}
function drawNP(){drawMini(document.getElementById('next-preview'),nextPiece?.type);drawMini(document.getElementById('hold-preview'),holdPiece);}

// ═══════ INPUT ═══════
function handleKey(e){
  if(e.target.tagName==='INPUT')return;
  if(!started||gameOver)return;
  if(e.code==='KeyP'){paused=!paused;document.getElementById('pause-text').style.display=paused?'block':'none';if(paused){pauseAll();nowPlaying.textContent='';}else if(!muted)resumeMusic();return;}
  if(e.code==='KeyM'){muteB.click();return;}
  if(e.code==='KeyN'){skipB.click();return;}
  if(paused)return;
  switch(e.code){
    case'ArrowLeft':if(valid(piece.cells,piece.x-1,piece.y)){piece.x--;sfxMove();}break;
    case'ArrowRight':if(valid(piece.cells,piece.x+1,piece.y)){piece.x++;sfxMove();}break;
    case'ArrowDown':if(valid(piece.cells,piece.x,piece.y+1)){piece.y++;score+=1;updateUI();sfxMove();}break;
    case'ArrowUp':case'KeyX':const rot=rotCells(piece.cells);for(const dx of[0,-1,1,-2,2]){if(valid(rot,piece.x+dx,piece.y)){piece.cells=rot;piece.x+=dx;sfxRotate();break;}}break;
    case'Space':while(valid(piece.cells,piece.x,piece.y+1)){piece.y++;score+=2;}sfxDrop();lock();updateUI();break;
    case'KeyC':if(!canHold)break;if(holdPiece){const t=holdPiece;holdPiece=piece.type;piece=createPiece(t);}else{holdPiece=piece.type;piece=nextPiece;nextPiece=createPiece(nextType());}canHold=false;drawNP();break;
  }
  e.preventDefault();
}
document.querySelectorAll('.mobile-btn').forEach(btn=>{btn.addEventListener('touchstart',e=>{e.preventDefault();if(!started||gameOver||paused)return;const a=btn.dataset.action;if(a==='left'&&valid(piece.cells,piece.x-1,piece.y)){piece.x--;sfxMove();}if(a==='right'&&valid(piece.cells,piece.x+1,piece.y)){piece.x++;sfxMove();}if(a==='down'&&valid(piece.cells,piece.x,piece.y+1)){piece.y++;score+=1;updateUI();sfxMove();}if(a==='rotate'){const rot=rotCells(piece.cells);for(const dx of[0,-1,1,-2,2]){if(valid(rot,piece.x+dx,piece.y)){piece.cells=rot;piece.x+=dx;sfxRotate();break;}}}if(a==='drop'){while(valid(piece.cells,piece.x,piece.y+1)){piece.y++;score+=2;}sfxDrop();lock();updateUI();}});});

// ═══════ LOOP ═══════
function loop(time){animFrame=requestAnimationFrame(loop);if(!started||gameOver||paused){drawBoard();return;}const dt=time-(lastTime||time);lastTime=time;dropTimer+=dt;if(dropTimer>=dropInterval){dropTimer=0;if(valid(piece.cells,piece.x,piece.y+1))piece.y++;else lock();}drawBoard();}
function initGame(){board=Array.from({length:ROWS},()=>new Array(COLS).fill(0));bag=[];score=0;level=1;lines=0;dropInterval=1000;dropTimer=0;lastTime=0;gameOver=false;paused=false;holdPiece=null;canHold=true;flashRows=[];piece=createPiece(nextType());nextPiece=createPiece(nextType());drawNP();updateUI();}

// ═══════ PLAYER NAME ═══════
let playerName='';

document.addEventListener('keydown',handleKey);

document.getElementById('name-input').addEventListener('keydown',e=>{if(e.code==='Enter'){document.getElementById('start-btn').click();e.preventDefault();}e.stopPropagation();});
document.getElementById('name-input-retry').addEventListener('keydown',e=>{if(e.code==='Enter'){document.getElementById('restart-btn').click();e.preventDefault();}e.stopPropagation();});

document.getElementById('start-btn').addEventListener('click',()=>{
  const nameEl=document.getElementById('name-input');
  playerName=nameEl.value.trim()||'player';
  document.getElementById('name-input-retry').value=playerName;
  document.getElementById('start-overlay').classList.add('hidden');
  started=true;initSfx();initGame();buildShuffleQueue();playNewSong();requestAnimationFrame(loop);
});
document.getElementById('restart-btn').addEventListener('click',()=>{
  const nameEl=document.getElementById('name-input-retry');
  if(nameEl.value.trim())playerName=nameEl.value.trim();
  document.getElementById('gameover-overlay').classList.add('hidden');
  initGame();buildShuffleQueue();playNewSong();
});
ctx.fillStyle='#fff9f5';ctx.fillRect(0,0,canvas.width,canvas.height);
document.getElementById('name-input').focus();
})();
</script>
</body>
</html>
