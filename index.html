<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>tetris ♡</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root {
  --cream: #faf6f1;
  --warm-white: #fff9f5;
  --blush: #f2d4d0;
  --rose: #d4868c;
  --dusty-rose: #c4737a;
  --soft-pink: #f0c0be;
  --mauve: #b88a95;
  --sage: #a8b5a0;
  --sky: #a3bdd4;
  --lavender: #b8a9d4;
  --butter: #e8d8a3;
  --peach: #e8b89d;
  --terracotta: #c49080;
  --text: #5a3e42;
  --text-soft: #9b7e82;
  --text-faint: #c4a8ab;
  --glass: rgba(255,255,255,0.55);
  --glass-border: rgba(212,134,140,0.18);
  --shadow: rgba(90,62,66,0.06);
}
html{height:100%}
body{background:var(--cream);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;display:flex;justify-content:center;align-items:center;overflow:hidden;position:relative}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 20%,rgba(242,212,208,0.25) 0%,transparent 50%),radial-gradient(ellipse at 80% 80%,rgba(184,169,212,0.12) 0%,transparent 50%),radial-gradient(ellipse at 60% 30%,rgba(168,181,160,0.08) 0%,transparent 40%);pointer-events:none}
.petal{position:fixed;pointer-events:none;z-index:0;opacity:0;animation:petalFall linear infinite}
@keyframes petalFall{0%{transform:translateY(-5vh) rotate(0deg) translateX(0);opacity:0}8%{opacity:0.07}85%{opacity:0.07}100%{transform:translateY(105vh) rotate(360deg) translateX(40px);opacity:0}}
.game-wrapper{position:relative;z-index:1;display:flex;gap:22px;align-items:flex-start}
.side-panel{width:146px;display:flex;flex-direction:column;gap:14px}
.panel-box{background:var(--glass);border:1px solid var(--glass-border);border-radius:14px;padding:14px 16px;backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);box-shadow:0 2px 20px var(--shadow)}
.panel-label{font-size:9px;font-weight:600;letter-spacing:2.5px;text-transform:uppercase;color:var(--text-faint);margin-bottom:6px}
.score-value{font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:600;color:var(--dusty-rose)}
.level-value{font-family:'Cormorant Garamond',serif;font-size:32px;font-weight:600;color:var(--lavender)}
.lines-value{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:600;color:var(--sage)}
.next-preview{display:flex;justify-content:center;align-items:center;min-height:70px}
.board-container{position:relative;border-radius:16px;padding:3px;background:linear-gradient(145deg,rgba(212,134,140,0.2),rgba(184,169,212,0.15),rgba(168,181,160,0.1));box-shadow:0 8px 40px rgba(212,134,140,0.1),0 1px 3px rgba(90,62,66,0.05)}
#game-canvas{display:block;border-radius:13px;background:var(--warm-white)}
.music-box{display:flex;flex-direction:column;gap:8px}
.song-btn{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--glass-border);background:var(--warm-white);font-family:'DM Sans',sans-serif;font-size:11px;font-weight:500;color:var(--text-soft);cursor:pointer;transition:all 0.2s;text-align:left;display:flex;align-items:center;gap:6px}
.song-btn:hover{border-color:var(--soft-pink);color:var(--dusty-rose);background:rgba(242,212,208,0.2)}
.song-btn.active{border-color:var(--rose);color:var(--dusty-rose);background:rgba(242,212,208,0.25)}
.song-btn .dot{width:6px;height:6px;border-radius:50%;background:var(--text-faint);flex-shrink:0;transition:all 0.2s}
.song-btn.active .dot{background:var(--rose);box-shadow:0 0 6px rgba(212,134,140,0.5)}
.song-btn.playing .dot{animation:pulse 1.2s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.5);opacity:0.6}}
.mute-btn{width:100%;padding:6px;border-radius:8px;border:1px solid var(--glass-border);background:transparent;font-family:'DM Sans',sans-serif;font-size:10px;font-weight:500;color:var(--text-faint);cursor:pointer;transition:all 0.2s;letter-spacing:1px}
.mute-btn:hover{border-color:var(--soft-pink);color:var(--text-soft)}
.mute-btn.muted{color:var(--terracotta);border-color:var(--terracotta)}
.controls-info{font-size:10px;line-height:2;color:var(--text-faint)}
.controls-info kbd{display:inline-block;font-family:'DM Sans',sans-serif;font-size:9px;font-weight:600;color:var(--text-soft);background:rgba(212,134,140,0.08);border:1px solid rgba(212,134,140,0.12);border-radius:4px;padding:1px 5px;margin-right:2px}
.overlay{position:absolute;inset:3px;border-radius:13px;background:rgba(250,246,241,0.95);display:flex;flex-direction:column;justify-content:center;align-items:center;gap:16px;z-index:10;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);transition:opacity 0.4s ease}
.overlay.hidden{opacity:0;pointer-events:none}
.overlay h1{font-family:'Cormorant Garamond',serif;font-size:52px;font-weight:400;font-style:italic;color:var(--dusty-rose);letter-spacing:2px}
.overlay h2{font-family:'Cormorant Garamond',serif;font-size:32px;font-weight:400;font-style:italic;color:var(--terracotta)}
.overlay .final-score{font-family:'Cormorant Garamond',serif;font-size:18px;color:var(--dusty-rose)}
.overlay .subtitle{font-size:12px;color:var(--text-faint);letter-spacing:1px}
.start-btn{font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;letter-spacing:3px;padding:13px 44px;border:1.5px solid var(--rose);background:transparent;color:var(--dusty-rose);border-radius:30px;cursor:pointer;transition:all 0.3s;text-transform:uppercase}
.start-btn:hover{background:var(--rose);color:white;box-shadow:0 4px 20px rgba(212,134,140,0.3);transform:translateY(-1px)}
.pause-indicator{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Cormorant Garamond',serif;font-size:26px;font-style:italic;color:var(--mauve);z-index:10;display:none;letter-spacing:4px}
.now-playing{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);font-size:9px;font-weight:500;color:var(--text-faint);letter-spacing:1px;z-index:5;white-space:nowrap;opacity:0.6}
.mobile-controls{display:none;position:fixed;bottom:14px;left:0;right:0;justify-content:center;gap:10px;z-index:100;padding:0 20px}
.mobile-btn{width:52px;height:52px;border-radius:50%;border:1px solid var(--glass-border);background:var(--glass);color:var(--dusty-rose);font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;-webkit-tap-highlight-color:transparent;user-select:none;backdrop-filter:blur(10px);box-shadow:0 2px 10px var(--shadow)}
.mobile-btn:active{background:rgba(242,212,208,0.4);border-color:var(--rose)}
@media(max-width:720px){.game-wrapper{flex-direction:column;align-items:center;gap:10px;transform:scale(0.78);transform-origin:center center}.side-panel{flex-direction:row;width:auto;gap:8px}.side-panel .panel-box{padding:10px 12px}.side-panel.right{display:none}.mobile-controls{display:flex}}
</style>
</head>
<body>
<script>
const pc=['✿','❀','♡','·','✧'];
for(let i=0;i<10;i++){const el=document.createElement('div');el.className='petal';el.textContent=pc[i%pc.length];el.style.left=(Math.random()*100)+'%';el.style.fontSize=(10+Math.random()*14)+'px';el.style.animationDuration=(18+Math.random()*22)+'s';el.style.animationDelay=(Math.random()*20)+'s';el.style.color=['#d4868c','#b8a9d4','#a8b5a0','#e8b89d'][i%4];document.body.appendChild(el);}
</script>
<div class="game-wrapper">
  <div class="side-panel">
    <div class="panel-box"><div class="panel-label">Score</div><div class="score-value" id="score">0</div></div>
    <div class="panel-box"><div class="panel-label">Level</div><div class="level-value" id="level">1</div></div>
    <div class="panel-box"><div class="panel-label">Lines</div><div class="lines-value" id="lines">0</div></div>
    <div class="panel-box"><div class="panel-label">Hold</div><div class="next-preview" id="hold-preview"></div></div>
  </div>
  <div class="board-container">
    <canvas id="game-canvas" width="300" height="600"></canvas>
    <div class="pause-indicator" id="pause-text">paused</div>
    <div class="now-playing" id="now-playing"></div>
    <div class="overlay" id="start-overlay">
      <h1>tetris</h1>
      <div class="subtitle">a cute little block game</div>
      <button class="start-btn" id="start-btn">play</button>
      <div class="controls-info" style="text-align:center;margin-top:6px">
        <kbd>←</kbd><kbd>→</kbd> move · <kbd>↑</kbd> rotate · <kbd>↓</kbd> soft drop<br>
        <kbd>space</kbd> hard drop · <kbd>c</kbd> hold · <kbd>p</kbd> pause
      </div>
    </div>
    <div class="overlay hidden" id="gameover-overlay">
      <h2>game over</h2>
      <div class="final-score" id="final-score"></div>
      <button class="start-btn" id="restart-btn">again</button>
    </div>
  </div>
  <div class="side-panel right">
    <div class="panel-box"><div class="panel-label">Next</div><div class="next-preview" id="next-preview"></div></div>
    <div class="panel-box">
      <div class="panel-label">Music</div>
      <div class="music-box">
        <button class="song-btn active" id="song1-btn"><span class="dot"></span>Espresso</button>
        <button class="song-btn" id="song2-btn"><span class="dot"></span>Tears</button>
        <button class="song-btn" id="song3-btn"><span class="dot"></span>Nonsense</button>
        <button class="mute-btn" id="mute-btn">♫ sound on</button>
      </div>
    </div>
    <div class="panel-box">
      <div class="controls-info">
        <kbd>←</kbd><kbd>→</kbd> move<br><kbd>↑</kbd> rotate<br><kbd>↓</kbd> soft drop<br>
        <kbd>space</kbd> hard drop<br><kbd>c</kbd> hold · <kbd>p</kbd> pause<br><kbd>m</kbd> mute · <kbd>1</kbd><kbd>2</kbd><kbd>3</kbd> songs
      </div>
    </div>
  </div>
</div>
<div class="mobile-controls">
  <div class="mobile-btn" data-action="left">◂</div>
  <div class="mobile-btn" data-action="rotate">↻</div>
  <div class="mobile-btn" data-action="down">▾</div>
  <div class="mobile-btn" data-action="drop">⤓</div>
  <div class="mobile-btn" data-action="right">▸</div>
</div>
<script>
(()=>{
const COLS=10,ROWS=20,CELL=30;
const canvas=document.getElementById('game-canvas');
const ctx=canvas.getContext('2d');
const COLORS={I:'#a3bdd4',O:'#e8d8a3',T:'#b8a9d4',S:'#a8b5a0',Z:'#d4868c',J:'#89a5c4',L:'#e8b89d'};
const GLOW={I:'rgba(163,189,212,0.3)',O:'rgba(232,216,163,0.3)',T:'rgba(184,169,212,0.3)',S:'rgba(168,181,160,0.3)',Z:'rgba(212,134,140,0.3)',J:'rgba(137,165,196,0.3)',L:'rgba(232,184,157,0.3)'};
const SHAPES={I:[[0,0],[1,0],[2,0],[3,0]],O:[[0,0],[1,0],[0,1],[1,1]],T:[[0,0],[1,0],[2,0],[1,1]],S:[[1,0],[2,0],[0,1],[1,1]],Z:[[0,0],[1,0],[1,1],[2,1]],J:[[0,0],[0,1],[1,1],[2,1]],L:[[2,0],[0,1],[1,1],[2,1]]};
const TYPES=Object.keys(SHAPES);
let board,piece,nextPiece,holdPiece,canHold,score,level,lines,gameOver,paused,started;
let dropInterval,dropTimer,lastTime,animFrame,flashRows=[];

// Music
const songs=[{name:'Espresso',src:'espresso.mp3'},{name:'Tears',src:'tears.mp3'},{name:'Nonsense',src:'nonsense.mp3'}];
let currentSong=0,muted=false;
let audio1=new Audio(songs[0].src),audio2=new Audio(songs[1].src),audio3=new Audio(songs[2].src);
audio1.loop=true;audio2.loop=true;audio3.loop=true;audio1.volume=0.4;audio2.volume=0.4;audio3.volume=0.4;
const audios=[audio1,audio2,audio3];
const song1Btn=document.getElementById('song1-btn'),song2Btn=document.getElementById('song2-btn'),song3Btn=document.getElementById('song3-btn');
const songBtns=[song1Btn,song2Btn,song3Btn];
const muteB=document.getElementById('mute-btn'),nowPlaying=document.getElementById('now-playing');

function switchSong(idx){
  audios[currentSong].pause();currentSong=idx;
  songBtns.forEach((b,i)=>{b.classList.toggle('active',i===idx);b.classList.remove('playing');});
  if(started&&!gameOver&&!paused&&!muted){audios[idx].play().catch(()=>{});songBtns[idx].classList.add('playing');}
  updNP();
}
function updNP(){nowPlaying.textContent=(muted||!started||gameOver)?'':'♫ '+songs[currentSong].name;}
function playMusic(){if(muted)return;audios[currentSong].play().catch(()=>{});songBtns[currentSong].classList.add('playing');updNP();}
function pauseAll(){audios.forEach(a=>a.pause());songBtns.forEach(b=>b.classList.remove('playing'));}
function stopAll(){audios.forEach(a=>{a.pause();a.currentTime=0;});songBtns.forEach(b=>b.classList.remove('playing'));nowPlaying.textContent='';}

song1Btn.addEventListener('click',()=>switchSong(0));
song2Btn.addEventListener('click',()=>switchSong(1));
song3Btn.addEventListener('click',()=>switchSong(2));
muteB.addEventListener('click',()=>{muted=!muted;muteB.textContent=muted?'♫ sound off':'♫ sound on';muteB.classList.toggle('muted',muted);if(muted){pauseAll();nowPlaying.textContent='';}else if(started&&!gameOver&&!paused)playMusic();});

// SFX
let sfxCtx=null,sfxGain=null;
function initSfx(){if(sfxCtx)return;sfxCtx=new(window.AudioContext||window.webkitAudioContext)();sfxGain=sfxCtx.createGain();sfxGain.gain.value=0.25;sfxGain.connect(sfxCtx.destination);}
function sfxN(f,s,d,w='sine',v=0.12){if(!sfxCtx||muted)return;const o=sfxCtx.createOscillator(),g=sfxCtx.createGain();o.type=w;o.frequency.value=f;g.gain.setValueAtTime(v,s);g.gain.exponentialRampToValueAtTime(0.001,s+d-0.005);o.connect(g);g.connect(sfxGain);o.start(s);o.stop(s+d);}
function sfxMove(){if(!sfxCtx||muted)return;sfxN(700,sfxCtx.currentTime,0.035,'sine',0.08);}
function sfxRotate(){if(!sfxCtx||muted)return;const t=sfxCtx.currentTime;sfxN(550,t,0.035,'sine',0.08);sfxN(800,t+0.035,0.035,'sine',0.08);}
function sfxDrop(){if(!sfxCtx||muted)return;const t=sfxCtx.currentTime;sfxN(260,t,0.06,'triangle',0.14);sfxN(140,t+0.04,0.08,'triangle',0.1);}
function sfxClear(n){if(!sfxCtx||muted)return;const t=sfxCtx.currentTime;(n>=4?[523,659,784,1047]:[440,554,659]).forEach((f,i)=>sfxN(f,t+i*0.06,0.14,'sine',0.14));}
function sfxOver(){if(!sfxCtx||muted)return;const t=sfxCtx.currentTime;[460,390,320,230].forEach((f,i)=>sfxN(f,t+i*0.18,0.3,'triangle',0.12));}

// Game
let bag=[];
function nextType(){if(!bag.length)bag=[...TYPES].sort(()=>Math.random()-0.5);return bag.pop();}
function createPiece(t){return{type:t,cells:SHAPES[t].map(c=>[...c]),x:Math.floor(COLS/2)-(t==='I'?2:t==='O'?1:1),y:-1};}
function rotCells(cells){const xs=cells.map(c=>c[0]),ys=cells.map(c=>c[1]);const cx=(Math.min(...xs)+Math.max(...xs))/2,cy=(Math.min(...ys)+Math.max(...ys))/2;return cells.map(([x,y])=>[Math.round(cy-y+cx),Math.round(x-cx+cy)]);}
function valid(cells,ox,oy){return cells.every(([x,y])=>{const nx=x+ox,ny=y+oy;return nx>=0&&nx<COLS&&ny<ROWS&&(ny<0||board[ny][nx]===0);});}
function lock(){piece.cells.forEach(([x,y])=>{const ny=y+piece.y;if(ny>=0)board[ny][x+piece.x]=piece.type;});clearLines();piece=nextPiece;nextPiece=createPiece(nextType());canHold=true;drawNP();if(!valid(piece.cells,piece.x,piece.y)){gameOver=true;stopAll();sfxOver();document.getElementById('final-score').textContent='score: '+score;document.getElementById('gameover-overlay').classList.remove('hidden');}}
function clearLines(){const full=[];for(let r=0;r<ROWS;r++)if(board[r].every(c=>c!==0))full.push(r);if(!full.length)return;sfxClear(full.length);flashRows=full;setTimeout(()=>{full.forEach(r=>{board.splice(r,1);board.unshift(new Array(COLS).fill(0));});flashRows=[];},280);score+=[0,100,300,500,800][full.length]*level;lines+=full.length;level=Math.floor(lines/10)+1;dropInterval=Math.max(50,1000-(level-1)*80);updateUI();}
function updateUI(){document.getElementById('score').textContent=score;document.getElementById('level').textContent=level;document.getElementById('lines').textContent=lines;}
function ghostY(){let gy=piece.y;while(valid(piece.cells,piece.x,gy+1))gy++;return gy;}

// Draw
function drawCell(x,y,type,alpha=1){
  const px=x*CELL,py=y*CELL;ctx.globalAlpha=alpha;
  const r=5,bx=px+1.5,by=py+1.5,bw=CELL-3,bh=CELL-3;
  ctx.fillStyle=COLORS[type];ctx.beginPath();ctx.roundRect(bx,by,bw,bh,r);ctx.fill();
  const grad=ctx.createLinearGradient(bx,by,bx,by+bh);
  grad.addColorStop(0,'rgba(255,255,255,0.4)');grad.addColorStop(0.35,'rgba(255,255,255,0.05)');grad.addColorStop(1,'rgba(0,0,0,0.04)');
  ctx.fillStyle=grad;ctx.beginPath();ctx.roundRect(bx,by,bw,bh,r);ctx.fill();
  ctx.strokeStyle='rgba(255,255,255,0.25)';ctx.lineWidth=0.5;ctx.beginPath();ctx.roundRect(bx+0.5,by+0.5,bw-1,bh-1,r-0.5);ctx.stroke();
  ctx.globalAlpha=1;
}
function drawBoard(){
  ctx.fillStyle='#fff9f5';ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='rgba(212,134,140,0.04)';
  for(let x=0;x<COLS;x++)for(let y=0;y<ROWS;y++){ctx.beginPath();ctx.arc(x*CELL+CELL/2,y*CELL+CELL/2,1,0,Math.PI*2);ctx.fill();}
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){if(board[r][c]){if(flashRows.includes(r))drawCell(c,r,board[r][c],(Date.now()%180)>90?1:0.15);else drawCell(c,r,board[r][c]);}}
  if(!piece||gameOver)return;
  const gy=ghostY();piece.cells.forEach(([x,y])=>{const ny=y+gy;if(ny>=0)drawCell(x+piece.x,ny,piece.type,0.15);});
  ctx.shadowColor=GLOW[piece.type];ctx.shadowBlur=10;
  piece.cells.forEach(([x,y])=>{const ny=y+piece.y;if(ny>=0)drawCell(x+piece.x,ny,piece.type);});
  ctx.shadowBlur=0;
}
function drawMini(container,type){
  container.innerHTML='';if(!type)return;
  const cells=SHAPES[type],xs=cells.map(c=>c[0]),ys=cells.map(c=>c[1]);
  const w=Math.max(...xs)-Math.min(...xs)+1,h=Math.max(...ys)-Math.min(...ys)+1,s=16;
  const cvs=document.createElement('canvas');cvs.width=w*s;cvs.height=h*s;
  const c=cvs.getContext('2d');const ox=Math.min(...xs),oy=Math.min(...ys);
  cells.forEach(([x,y])=>{const px=(x-ox)*s,py=(y-oy)*s;c.fillStyle=COLORS[type];c.beginPath();c.roundRect(px+1,py+1,s-2,s-2,3);c.fill();const g=c.createLinearGradient(px,py,px,py+s);g.addColorStop(0,'rgba(255,255,255,0.35)');g.addColorStop(0.4,'rgba(255,255,255,0)');c.fillStyle=g;c.beginPath();c.roundRect(px+1,py+1,s-2,s-2,3);c.fill();});
  container.appendChild(cvs);
}
function drawNP(){drawMini(document.getElementById('next-preview'),nextPiece?.type);drawMini(document.getElementById('hold-preview'),holdPiece);}

// Input
function handleKey(e){
  if(!started||gameOver)return;
  if(e.code==='KeyP'){paused=!paused;document.getElementById('pause-text').style.display=paused?'block':'none';if(paused){pauseAll();nowPlaying.textContent='';}else if(!muted)playMusic();return;}
  if(e.code==='KeyM'){muteB.click();return;}
  if(e.code==='Digit1'||e.code==='Numpad1'){switchSong(0);return;}
  if(e.code==='Digit2'||e.code==='Numpad2'){switchSong(1);return;}
  if(e.code==='Digit3'||e.code==='Numpad3'){switchSong(2);return;}
  if(paused)return;
  switch(e.code){
    case'ArrowLeft':if(valid(piece.cells,piece.x-1,piece.y)){piece.x--;sfxMove();}break;
    case'ArrowRight':if(valid(piece.cells,piece.x+1,piece.y)){piece.x++;sfxMove();}break;
    case'ArrowDown':if(valid(piece.cells,piece.x,piece.y+1)){piece.y++;score+=1;updateUI();sfxMove();}break;
    case'ArrowUp':case'KeyX':const rot=rotCells(piece.cells);for(const dx of[0,-1,1,-2,2]){if(valid(rot,piece.x+dx,piece.y)){piece.cells=rot;piece.x+=dx;sfxRotate();break;}}break;
    case'Space':while(valid(piece.cells,piece.x,piece.y+1)){piece.y++;score+=2;}sfxDrop();lock();updateUI();break;
    case'KeyC':if(!canHold)break;if(holdPiece){const t=holdPiece;holdPiece=piece.type;piece=createPiece(t);}else{holdPiece=piece.type;piece=nextPiece;nextPiece=createPiece(nextType());}canHold=false;drawNP();break;
  }
  e.preventDefault();
}
document.querySelectorAll('.mobile-btn').forEach(btn=>{btn.addEventListener('touchstart',e=>{e.preventDefault();if(!started||gameOver||paused)return;const a=btn.dataset.action;if(a==='left'&&valid(piece.cells,piece.x-1,piece.y)){piece.x--;sfxMove();}if(a==='right'&&valid(piece.cells,piece.x+1,piece.y)){piece.x++;sfxMove();}if(a==='down'&&valid(piece.cells,piece.x,piece.y+1)){piece.y++;score+=1;updateUI();sfxMove();}if(a==='rotate'){const rot=rotCells(piece.cells);for(const dx of[0,-1,1,-2,2]){if(valid(rot,piece.x+dx,piece.y)){piece.cells=rot;piece.x+=dx;sfxRotate();break;}}}if(a==='drop'){while(valid(piece.cells,piece.x,piece.y+1)){piece.y++;score+=2;}sfxDrop();lock();updateUI();}});});

// Loop
function loop(time){animFrame=requestAnimationFrame(loop);if(!started||gameOver||paused){drawBoard();return;}const dt=time-(lastTime||time);lastTime=time;dropTimer+=dt;if(dropTimer>=dropInterval){dropTimer=0;if(valid(piece.cells,piece.x,piece.y+1))piece.y++;else lock();}drawBoard();}
function initGame(){board=Array.from({length:ROWS},()=>new Array(COLS).fill(0));bag=[];score=0;level=1;lines=0;dropInterval=1000;dropTimer=0;lastTime=0;gameOver=false;paused=false;holdPiece=null;canHold=true;flashRows=[];piece=createPiece(nextType());nextPiece=createPiece(nextType());drawNP();updateUI();}

document.addEventListener('keydown',handleKey);
document.getElementById('start-btn').addEventListener('click',()=>{document.getElementById('start-overlay').classList.add('hidden');started=true;initSfx();initGame();playMusic();requestAnimationFrame(loop);});
document.getElementById('restart-btn').addEventListener('click',()=>{document.getElementById('gameover-overlay').classList.add('hidden');initGame();playMusic();});
ctx.fillStyle='#fff9f5';ctx.fillRect(0,0,canvas.width,canvas.height);
})();
</script>
</body>
</html>
